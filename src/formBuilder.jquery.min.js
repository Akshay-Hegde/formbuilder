/**
 * jQuery form builder
 * Copyright (c) 2014 (v3.0) Shlomi Nissan, 1ByteBeta (http://www.1bytebeta.com)
 * Licensed under the MIT (http://www.opensource.org/licenses/mit-license.php)
 */(function(e){e.fn.formBuilder=function(t){var n=e.extend({load_url:"/",save_url:"/"},t),r="";dust.onLoad=function(t,n){e.ajax("src/templates/"+t+".tpl",{success:function(e){n(undefined,e)},error:function(e,t,r){n(t,undefined)}})};var i={fields:!0,fieldSettings:!1,formSettings:!1};dust.render("formbuilder",i,function(t,r){e("#wf-form-builder").append(r);e.getJSON(n.load_url,function(e){p(e)});l();a();u();h();d();e("#save").click(function(){w()})});var s=function(){r="";e(".form-element").each(function(){e(this).removeClass("selected")})},o=function(){e("#field-label").val(r.data("label"));e("#field-label").on("keyup",function(){r.children("label").children(".label-title").html(e(this).val());r.data("label",e(this).val())});if(r.data("type")=="element-multiple-choice"){e("#field-choices").css("display","block");e("#field-choices").html('<div class="form-group"><label>Choices</label></div>');r.children(".choices").children(".radio").each(function(t){var n=e(this).children("label").children("input").is(":checked")?!0:!1,i=e(this).children("label").children("input").attr("class"),s=e(this).children("label").children(".choice-label").html(),o={checked:n,title:s,position:t+1,bindingClass:i};dust.render(r.children(".choices").data("type"),o,function(t,n){e("#field-choices").append(n);a();y();b()})})}else e("#field-choices").css("display","none");r.hasClass("required")?e("#required").prop("checked",!0):e("#required").prop("checked",!1);e("#required").unbind();e("#required").change(function(){r.toggleClass("required");var e={};this.checked?dust.render("required",e,function(e,t){r.children("label").append(t)}):r.children("label").children(".required-star").remove()})},u=function(){e(".toolbox-tab").click(function(){s();e(this).data("target")=="#form-settings"&&e("#form-settings-element").addClass("selected");if(e(this).data("target")=="#field-settings"){e("#element-1").addClass("selected");r=e("#element-1");o()}})},a=function(){e(".bind-control").each(function(){var t=e(this).data("bind");e(this).on("keyup",function(){r==""?e(t).html(e(this).val()):r.find(t).next(".choice-label").html(e(this).val())})})},f=function(){e("#sortable-elements li").each(function(t){e(this).attr("id","element-"+(t+1))});c()},l=function(){e(".new-element").click(function(){s();var t=e("#sortable-elements");t.sortable({stop:function(){f()}});var n=e(this).data("type"),i={label:"Untitled",position:e(".form-element").length};dust.render(n,i,function(n,s){t.append(s);c();var u=e("#element-"+i.position);r=u;r.addClass("selected");g("#field-settings");o()})})},c=function(){e(".form-element").unbind();e(".form-element").click(function(){s();e(this).addClass("selected");if(e(this).data("type")=="form-settings")g("#form-settings");else{g("#field-settings");r=e(this);o()}})},h=function(){e("#control-remove-field").click(function(){if(r!="")if(e(".form-element").length>2){r.remove();f();g("#add-field");r="";s()}else alert("Unable to delete this field! You must have at least 1 field in your form.")});e("#control-add-field").click(function(){g("#add-field");r="";s()})},p=function(t){e("#form-title").val(t.title);e("#form-title-label").html(t.title);e("#form-description").val(t.description);e("#form-description-label").html(t.description);var t;e.each(t.fields,function(t,n){var r=dust.makeBase({label:n.title,position:t,required:n.required,choices:n.choices});dust.render(n.type,r,function(t,r){e("#sortable-elements").append(r);var i=e("#sortable-elements").children("li").length;c();f();e("#element-"+i).children(".choices").html("");if(n.type=="element-multiple-choice"){var s;for(var o=0;o<n.choices.length;o++){s={title:n.choices[o].title,value:n.choices[o].value,checked:n.choices[o].checked,lastChoice:o,elementId:i};dust.render("choice-radio",s,function(t,n){e("#element-"+i).children(".choices").append(n)})}}})});e("#form-col").fadeIn();e("#sortable-elements").sortable({stop:function(){f()}})},d=function(){e(".tab-content .tab-pane").css("display","none");v();e(".nav-tabs li").click(function(){m();e(this).addClass("active");v()})},v=function(){e(".nav-tabs li").each(function(t){var n=e(this).data("target");e(this).hasClass("active")?e(n).css("display","block"):e(n).css("display","none")})},m=function(){e(".nav-tabs li").each(function(){e(this).removeClass("active")})},g=function(t){m();e(".nav-tabs li").each(function(){e(this).data("target")==t&&e(this).addClass("active")});v()},y=function(){e(".remove-choice").unbind();e(".remove-choice").click(function(){if(e(this).parent().parent().children(".choice").length>1){var t=e(this).data("delete");e(r).find(t).parent().parent().remove();e(this).parent().remove();a();y()}});e(".add-choice").unbind();e(".add-choice").click(function(){var t=2;e(r.children(".choices").children(".choice")).each(function(n){var r=e(this).find("input").attr("class"),i=r.split("-");t<i[1]&&(t=i[1])});t++;var n={bindingClass:"option-"+t,title:"Untitled"};dust.render(r.children(".choices").data("type"),n,function(i,s){e("#field-choices").append(s);r.data("type")=="element-multiple-choice"&&(template="choice-radio");var o=r.attr("id").replace("element-","");n={title:"Untitled",value:"untitled",lastChoice:t,elementId:o};dust.render(template,n,function(e,t){r.children(".choices").append(t)});a();y();b()})})},b=function(){e(".radio-option").unbind();e(".radio-option").click(function(){var t=e(this).parent().next("input").data("bind");e(r).find(t).prop("checked",!0)})},w=function(){var t={};t.title=e("#form-title").val();t.description=e("#form-description").val();t.fields=Array();e("#sortable-elements li").each(function(){var n={title:e(this).data("label"),type:e(this).data("type"),required:e(this).hasClass("required")?!0:!1};if(n["type"]=="element-multiple-choice"){var r=[];e(this).find(".choices").children(".choice").each(function(t){var i={title:e(this).children("label").children(".choice-label").html(),value:e(this).children("label").children(".choice-label").html(),checked:e(this).children("label").children("input").is(":checked")?!0:!1};r.push(i);n.choices=r})}t.fields.push(n)});var n=JSON.stringify(t);alert(n)}}})(jQuery);